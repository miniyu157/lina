#!/system/bin/sh

# SPDX-License-Identifier: GPL-3.0-or-later
# Copyright (C) 2025 Yumeka <miniyu157@163.com>

# shellcheck shell=ksh

if [ "$(id -u)" -ne 0 ]; then
    current_script="$(cd "$(dirname "$0")" && pwd)/$(basename "$0")"
    quoted_args=$(printf " %q" "$@")
    exec su -M -c "exec '$current_script'$quoted_args"
fi
ScriptDir="$(cd "$(dirname "$0")" && pwd)"

# 启用此段以使用 makepkg 风格输出
if [[ ! -f "$ScriptDir/lib/message.sh" ]]; then
    echo "错误: 未找到 $ScriptDir/lib/message.sh" >&2
    exit 1
fi
source "$ScriptDir/lib/message.sh"
QUIET=0
colorize

# 启用此行以使用其它自定义脚本
#PATH="$ScriptDir:$PATH"
# 启用以下两行以使用 Termux 中的二进制程序和库
#export LD_LIBRARY_PATH="/data/data/com.termux/files/usr/lib"
#PATH="/data/data/com.termux/files/usr/bin:$PATH"

BasePath="/data/local/chroot"

usage() {
    cat << EOF
进入 chroot 根文件系统。

用法:
  ${0##*/} <Name> - [User] [选项...]
  ${0##*/} <Name> [选项...]

参数:
  Name          chroot 环境的名称
  User          登录用户 (默认: root)

选项:
  -c COMMAND    在 chroot 内运行的命令
  -h            显示此帮助信息
EOF
    exit "${1:-0}"
}

[[ "$1" == "-h" ]] && usage 0

Name="$1"
[[ -z "$Name" ]] && {
    error "未提供名称。"
    usage 1
}
shift

LoginUser="root"
RunCommand=""

if [[ "$1" == "-" ]]; then
    shift
    if [[ -n "$1" && "$1" != -* ]]; then
        LoginUser="$1"
        shift
    fi
fi

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h)
            usage 0
            ;;
        -c)
            [[ -z "$2" ]] && error "选项 -c 需要一个参数。" && usage 1
            RunCommand="$2"
            shift 2
            ;;
        *)
            error "未知选项: $1"
            usage 1
            ;;
    esac
done

RootFs="$BasePath/$Name"
[[ -d "$RootFs" ]] || {
    error "目录 '$RootFs' 不存在。"
    exit 1
}

echo $$ | tee /dev/cpuctl/cgroup.procs /dev/cpuset/cgroup.procs /dev/memcg/cgroup.procs > /dev/null 2>&1

# shellcheck disable=SC2016
exec unshare -u chroot "$RootFs" /bin/sh -c '
    User="$1"
    Command="$2"
    
    [ -e /proc/sys/kernel/hostname ] && [ -r /etc/hostname ] && read -r HN < /etc/hostname && echo "$HN" > /proc/sys/kernel/hostname

    if [ -n "$Command" ]; then
        if [ -x /bin/su ]; then
            exec /bin/su - "$User" -c "$Command"
        else
            exec /bin/sh -c "$Command"
        fi
    fi

    if [ -x /bin/su ]; then
        exec /bin/su - "$User"
    elif [ -x /bin/bash ]; then
        exec /bin/bash
    else
        exec /bin/sh
    fi
' -- "$LoginUser" "$RunCommand"

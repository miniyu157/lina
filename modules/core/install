#!/system/bin/sh

# SPDX-License-Identifier: GPL-3.0-or-later
# Copyright (C) 2025 Yumeka <miniyu157@163.com>

# shellcheck shell=ksh

if (($(id -u) != 0)); then
    current_script="$(cd "$(dirname "$0")" && pwd)/$(basename "$0")"
    quoted_args=$(printf " %q" "$@")
    exec su -M -c "exec '$current_script'$quoted_args"
fi
ScriptDir="$(cd "$(dirname "$0")" && pwd)"

# 启用此段以使用 makepkg 风格输出
if [[ ! -f "$ScriptDir/lib/message.sh" ]]; then
    echo "错误: 未找到 $ScriptDir/lib/message.sh" >&2
    exit 1
fi
source "$ScriptDir/lib/message.sh"
QUIET=0
colorize

# 启用以下两行以使用 Termux 中的二进制程序和库
export LD_LIBRARY_PATH="/data/data/com.termux/files/usr/lib"
PATH="/data/data/com.termux/files/usr/bin:$PATH"

BasePath="/data/local/chroot"
DisplayCmd="${LINA_ENTRY:+$LINA_ENTRY $LINA_ACTION}"
DisplayCmd="${DisplayCmd:-${0##*/}}"

usage() {
    cat << EOF
部署官方纯净的 Linux Chroot 环境。

用法: $DisplayCmd <distro:version> [选项...] [Name]

参数:
  distro:version    发行版及版本, 如 ubuntu:22.04
  Name              自定义环境名称 (可选, 默认跟随 distro 名称)

选项:
  -n, --name <name> 指定 chroot 环境的名称 (同位置参数 Name)
  -l, --list        列出可用的发行版
  -h, --help        显示此帮助信息
EOF
    exit 1
}

DistrosDir="$ScriptDir/distros"

list_distros() {
    for f in "$DistrosDir"/*; do
        [[ -f $f ]] || continue
        n="${f##*/}"
        printf "%s\n" "${n%.*}"
    done
    exit 0
}

Name=""
DistroInput=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        -l | --list)
            list_distros
            ;;
        -n | --name)
            Name="$2"
            shift 2
            ;;
        -h | --help)
            usage
            ;;
        *:*)
            DistroInput="$1"
            shift
            ;;
        *)
            # 如果没有指定 -n，且不是 distro:ver 格式，则认为是 Name
            if [[ -z $Name ]]; then
                Name="$1"
            fi
            shift
            ;;
    esac
done

if [[ -z $DistroInput ]]; then
    error "未指定发行版 (distro:version)。"
    usage
fi

Distro="${DistroInput%%:*}"
Version="${DistroInput##*:}"

if [[ ! -d $BasePath ]]; then
    mkdir -p "$BasePath" || exit 1
fi

[[ -z $Name ]] && PendingName=1

Name="${Name:-$Distro}"
RootFs="$BasePath/$Name"
if [[ -d $RootFs ]]; then
    ErrorMessage="目录 '$RootFs' 已存在。"
    [[ -n $PendingName ]] &&
        ErrorMessage="$ErrorMessage 请用 -n 指定另外一个名称。"

    error "$ErrorMessage"
    exit 1
fi

# ---- 初始化发行版数据 ----
DistroFile="$DistrosDir/$Distro.sh"
# shellcheck disable=SC1090
source "$DistroFile" > /dev/null 2>&1 || {
    error "不支持的发行版: %s, 未找到定义文件。" "$Distro"
    exit 1
}
command -v distro_init > /dev/null 2>&1 || {
    error "定义文件损坏: '%s', 缺少 distro_init() 方法。" "$DistroFile"
    exit 1
}
command -v distro_sum > /dev/null 2>&1 || distro_sum() {
    "$SUM_CMD" -c "$2" > /dev/null 2>&1
}
command -v distro_hook > /dev/null 2>&1 || distro_hook() {
    msg2 "未进行任何操作。"
}

distro_init

# ---- 安装开始 ----
cd "$BasePath" || exit 1

msg "获取校验文件..."
curl -sL -o "$SUM_FILE" "$SUM_URL"
[[ -f $SUM_FILE ]] || {
    error "下载校验文件失败。"
    exit 1
}

if [[ -f $TAR_FILE ]]; then
    msg "发现本地 tarball。正在校验, 使用 %s" "$SUM_CMD"
    if distro_sum "$TAR_FILE" "$SUM_FILE"; then
        msg2 "校验和通过, 跳过下载。"
    else
        msg2 "校验和错误, 重新下载。"
        rm -f "$TAR_FILE"
        curl -L -o "$TAR_FILE" "$TAR_URL"
    fi
else
    msg "获取 tarball..."
    msg2 "下载 $TAR_FILE..."
    curl -L -o "$TAR_FILE" "$TAR_URL"
fi

[[ -f $TAR_FILE ]] || {
    error "下载失败。"
    rm -f "$SUM_FILE"
    exit 1
}

distro_sum "$TAR_FILE" "$SUM_FILE" || {
    error "下载文件校验失败!"
    rm -f "$SUM_FILE"
    exit 1
}

msg "创建目标目录: %s" "$RootFs"
mkdir -p "$RootFs"

msg "解压 tarball..."
if ! tar -xpf "$TAR_FILE" -C "$RootFs"; then
    error "'%s' 似乎不是 tar 归档文件, 确定发行版 %s 有版本 %s 吗?" "$TAR_FILE" "$Distro" "$Version"
    rm -f "$TAR_FILE"
    rm -f "$SUM_FILE"
    rm -rf "$RootFs"
    exit 1
fi

msg "进行后续处理..."
post_configure() {
    local rootfs="$1"
    local resolv_conf="$rootfs/etc/resolv.conf"

    mkdir -p "$rootfs/etc"

    if [[ ! -s $resolv_conf ]]; then
        msg2 "修复 DNS 配置..."
        rm -f "$resolv_conf"
        echo "nameserver 8.8.8.8" > "$resolv_conf"
    fi

    msg2 "设置 hosts..."
    cat > "$rootfs/etc/hosts" << EOF
127.0.0.1       localhost
::1             ip6-localhost
EOF

    msg "执行 distro_hook()..."
    distro_hook "$rootfs"
}
post_configure "$RootFs"

rm -f "$SUM_FILE"

msg "安装完成: $Name ($DistroInput)"
msg2 "Tarball 保留在: $TAR_FILE"

echo ""

Pfx="${LINA_ENTRY:+$LINA_ENTRY }"

plain "提示信息:"
plain "  1) 使用 '${Pfx}mount $Name' 挂载文件系统"
plain "  2) 使用 '${Pfx}enter $Name' 进行登录"
plain "  3) 更多信息查看 https://github.com/miniyu157/lina"

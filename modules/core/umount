#!/system/bin/sh

# SPDX-License-Identifier: Apache-2.0
# Copyright (C) 2025 Yumeka <miniyu157@163.com>

# shellcheck shell=ksh

(($(id -u) != 0)) && exec su --mount-master -c "$(printf "%q " "$(readlink -f "$0")" "$@")"
ScriptDir=$(dirname "$0")
[[ -f "$ScriptDir/lib/ui.sh" ]] || {
    echo "错误: 未找到 $ScriptDir/lib/ui.sh" >&2
    exit 1
}
source "$ScriptDir/lib/ui.sh"

BasePath="/data/local/chroot"
DisplayCmd="${LINA_ENTRY:+$LINA_ENTRY $LINA_ACTION}"
DisplayCmd="${DisplayCmd:-${0##*/}}"

usage() {
    cat << EOF
卸载 chroot 文件系统。

用法: $DisplayCmd <Name>

参数:
  Name    chroot 环境的名称
EOF
    exit 1
}

Name="$1"
[[ -z $Name ]] && {
    m1err "未提供名称。"
    usage 1
}
RootFs="$BasePath/$Name"
[[ -d $RootFs ]] || {
    m1err "目录 '$RootFs' 不存在。"
    exit 1
}

try_umount_stacked() {
    local target_path="$1"
    local unmounted_count=0

    while umount -l "$target_path" 2> /dev/null; do
        ((unmounted_count++))

        if ((unmounted_count >= 50)); then
            m1err "无法卸载 %s, 重试次数达到 50 次" "$target_path"
            exit 1
        fi

        m2green "卸载[%s]: %s" "$unmounted_count" "$target_path"
    done

    if ((unmounted_count <= 0)); then
        m2yellow "跳过: %s" "$target_path"
    fi
}

try_umount_stacked "$RootFs/tmp"
try_umount_stacked "$RootFs/sdcard"
try_umount_stacked "$RootFs/sys"
try_umount_stacked "$RootFs/proc"
try_umount_stacked "$RootFs/dev/shm"
try_umount_stacked "$RootFs/dev/pts"
try_umount_stacked "$RootFs/dev"

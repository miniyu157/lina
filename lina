#!/system/bin/sh

# SPDX-License-Identifier: GPL-3.0-or-later
# Copyright (C) 2025 Yumeka <miniyu157@163.com>

# shellcheck shell=ksh

BinDir="$(dirname "$(readlink -f "$0")")"
Self="${0##*/}"

[[ -f "$BinDir/.lina-dev" ]] || {
    [[ -f "$BinDir/update.lock" ]] && {
        echo "$Self 上次启动时进行了更新, 更新内容是:"
        cat "$BinDir/update.lock"
        rm -f "$BinDir/update.lock"
        echo ""
    }
    (cd "$BinDir" && sh lina-update > /dev/null 2>&1 &)
}

G=$'\e[38;5;243m'
W=$'\e[0m'
B=$'\e[1m'

paint() {
    sed -e "s/%B/$B/g" \
        -e "s/%G/$G/g" \
        -e "s/%W/$W/g"
}

if [ -z "$1" ]; then
    Cmds=""
    for File in "$BinDir"/chroot-*; do
        [ -x "$File" ] || continue
        case ${File##*/} in
            *.test) ;;
            *.*) continue ;;
        esac
        Cmds="$Cmds, ${File##*chroot-}"
    done

    cat << 'EOF' | paint

%G  .---.    %W%B.-./`)%W%G ,---.   .--.   ____     %W
%G  | %W%B,_%W%G|    %W%B\ .-.')%W%G|    \  |  | .'  __ `.  %W
%G%W%B,-./  )    / `-' \%W%G|  ,  \ |  |/   '  \  \ %W
%G%W%B\  '_ '`)   `-'`"`%W%G|  |\_ \|  ||___|  /  | %W
%G%W%B > (_)  )%W%G   .---. |  %W%B_( )_%W%G\  |   _.-`   | %W
%G%W%B(  .  .-'%W%G   |   | | %W%B(_ o _)%W%G  |.'   %W%B_%W%G    | %W
%G %W%B`-'`-'%W%G|___ |   | |  %W%B(_,_)%W%G\  ||  %W%B_( )_%W%G  | %W
%G  |        \|   | |  |    |  |\ %W%B(_ o _)%W%G / %W
%G  `--------`'---' '--'    '--' '.%W%B(_,_)%W%G.'  %W

EOF

    cat << EOF
用法: $Self <指令> [参数...]
可用指令: ${Cmds#, }
EOF
    exit 1
fi

Action="$1"
shift
TargetScript="$BinDir/chroot-$Action"

if [ -x "$TargetScript" ]; then
    export LINA_ENTRY="$Self"
    export LINA_ACTION="$Action"
    exec "$TargetScript" "$@"
else
    echo "错误: 未知的指令 '$Action'" >&2
    echo "请运行 '$Self' 以查看可用指令。" >&2
    exit 1
fi
